# 基于Supabase MCP的邮箱验证与状态处理实现

## 1. 核心需求分析
需要实现完整的用户注册流程，包括邮箱唯一性验证、验证邮件发送、已注册用户状态处理和重新发送验证邮件功能。

## 2. 技术架构
- **前端框架**：Next.js 13+ App Router
- **认证服务**：Supabase Auth
- **数据库操作**：Supabase MCP API
- **状态管理**：React Context API
- **表单处理**：React Hook Form + Zod

## 3. 实现步骤

### 3.1 修改AuthContext.tsx
- 扩展`AuthContextType`接口，添加`checkEmailExists`方法
- 实现`checkEmailExists`方法，使用`mcp_supabase_execute_sql`查询邮箱是否存在
- 修改`register`方法，添加邮箱唯一性检查逻辑
- 实现`resendVerificationEmail`方法，处理重新发送验证邮件

### 3.2 修改register/page.tsx
- 优化注册表单UI，添加加载状态
- 添加重新发送验证邮件的UI组件
- 实现状态流转逻辑：
  - 邮箱不存在：显示发送验证邮件提示
  - 邮箱已存在（已验证）：显示提示，2秒后跳转登录
  - 邮箱已存在（未验证）：显示提示，提供重新发送按钮
- 添加清晰的视觉反馈（加载状态、成功/错误提示）

### 3.3 实现邮箱验证状态处理
- 使用`mcp_supabase_execute_sql`查询`auth.users`表，获取邮箱验证状态
- 根据验证状态执行不同的处理逻辑
- 确保状态转换平滑，用户体验连贯

### 3.4 实现重新发送验证邮件功能
- 添加重新发送按钮的点击事件处理
- 调用Supabase Auth的resendConfirmationEmail方法
- 处理限流、网络错误等异常情况
- 提供相应的用户反馈

## 4. 数据库查询设计
```sql
-- 检查邮箱是否存在并获取验证状态
SELECT email_confirmed_at FROM auth.users WHERE email = $1 LIMIT 1;
```

## 5. 状态流转设计
1. 用户输入邮箱密码提交注册
2. 系统查询数据库验证邮箱唯一性
3. 根据查询结果：
   - 邮箱不存在：发送验证邮件 → 显示成功提示
   - 邮箱存在（已验证）：显示提示 → 2秒后跳转登录
   - 邮箱存在（未验证）：显示提示 → 提供重新发送按钮
4. 未验证用户点击重新发送 → 调用resend方法 → 显示结果反馈

## 6. 用户体验优化
- 添加加载动画，提示用户系统正在处理
- 成功/错误提示信息清晰明确
- 跳转过程平滑过渡
- 重新发送按钮有明确的状态反馈
- 所有交互有明确的视觉反馈

## 7. 错误处理
- 处理数据库查询错误
- 处理Supabase Auth API错误
- 处理网络异常
- 处理限流情况
- 提供友好的错误提示

## 8. 测试要点
- 新用户注册流程
- 已验证用户注册流程
- 未验证用户注册流程
- 重新发送验证邮件功能
- 各种错误情况的处理
- 状态流转的正确性
- 用户体验的连贯性

## 9. 代码质量要求
- 代码结构清晰，易于维护
- 遵循TypeScript类型安全
- 符合Supabase最佳实践
- 良好的错误处理机制
- 清晰的注释和文档

这个实现方案将确保用户注册流程中的邮箱验证与状态处理逻辑完整、可靠，并提供良好的用户体验。