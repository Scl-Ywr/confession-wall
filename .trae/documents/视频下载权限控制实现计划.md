# 视频下载权限控制实现计划

## 1. 分析现有代码结构

- 视频和图片都存储在 `confession_images` 表中，通过 `file_type` 字段区分
- 现有系统已经支持图片的锁功能，包括密码锁、仅用户锁和公开锁
- 前端组件 `ConfessionCard.tsx` 已经有处理锁和下载的逻辑
- API 端点 `toggle-media-lock` 和 `download-media` 已经支持锁功能

## 2. 实现步骤

### 2.1 数据库表更新
- 检查 `confession_images` 表是否已经包含锁相关字段（`is_locked`, `lock_type`, `lock_password`）
- 如果没有，需要添加这些字段

### 2.2 前端组件修改
- 确保 `ConfessionCard.tsx` 中的锁和下载逻辑适用于视频
- 检查 `handleDownload` 函数是否正确处理视频下载
- 确保锁图标显示在视频上

### 2.3 API 端点检查
- 确保 `toggle-media-lock` API 支持视频文件
- 确保 `download-media` API 支持视频文件
- 检查下载逻辑是否正确处理不同锁类型

### 2.4 视频播放器集成
- 确保 `VideoPlayer.tsx` 组件允许视频正常播放，不受锁状态影响
- 只有在下载时才检查锁状态

## 3. 具体实现

### 3.1 数据库检查
- 检查 `confession_images` 表结构
- 如有必要，运行迁移添加锁相关字段

### 3.2 前端修改
- 更新 `ConfessionCard.tsx` 中的 `handleDownload` 函数，确保视频下载正确处理锁状态
- 确保锁图标正确显示在视频上
- 确保密码输入模态框适用于视频下载

### 3.3 API 检查
- 检查 `toggle-media-lock` API 逻辑，确保它适用于所有媒体类型
- 检查 `download-media` API 逻辑，确保它适用于所有媒体类型
- 确保下载逻辑正确处理不同锁类型

### 3.4 测试
- 测试视频加锁功能
- 测试不同锁类型下的视频下载
- 确保视频播放不受锁状态影响

## 4. 预期效果

- 用户可以点击视频上的锁图标给视频加锁
- 密码锁：用户点击下载时需要输入密码
- 仅用户锁：非登录用户点击下载时需要登录
- 公开锁：任何用户都可以下载
- 视频播放不受锁状态影响，始终可以正常播放

## 5. 文件修改清单

- `src/components/ConfessionCard.tsx`：确保锁和下载逻辑适用于视频
- 检查 `src/app/api/toggle-media-lock/route.ts`：确保支持视频
- 检查 `src/app/api/download-media/route.ts`：确保支持视频
- 检查 `confession_images` 表结构：确保包含锁相关字段